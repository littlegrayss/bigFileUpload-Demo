<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <input type="file" name="upload" id="upload" accept="*">
    <button onclick="submit()">submit</button>
    <script>
        const sliceChunkSize = 2 * 1024 * 1024
        async function submit() {
            const [file] = document.querySelector('#upload').files
            console.dir(file);

            let chunkList = []
            if (file.size > sliceChunkSize) {
                chunkList = sliceChunk(file, sliceChunkSize)
                
            } else {
                chunkList = [{
                    filename: file.name,
                    chunk: file,
                    index: 0
                }]
            }
            console.log(chunkList);
            await uploadChunk(chunkList)
            
        }
        const uploadChunk = async (chunkList) => {
            let waitUpload = chunkList.map(({filename, chunk, index}) => {
                console.log({filename, chunk, index});
                let fd = new FormData()
                fd.append('filename', filename)
                fd.append('chunk', chunk)
                fd.append('index', index)
                return fd
            }).map(formData => {
                request({
                    methods: 'post',
                    url: 'http://127.0.0.1:3000/api/upload',
                    // headers: {
                    //     'Content-Type': 'multipart/form-data'
                    // },
                    params: formData
                })
            })
            await Promise.all(waitUpload)
            request({
                methods: 'post',
                url: 'http://127.0.0.1:3000/api/merge',
                headers: {
                    "content-type": "application/json"
                },
                params: JSON.stringify({
                    file: filename,
                    length: chunkList.length
                })
            })
        }
        const sliceChunk = (file, chunkSize) => {
            const chunkList = []
            const size = file.size
            const filename = file.name
            let cur = 0
            let idx = 0
            while (cur <= size) {
                let chunk = {
                    chunk: file.slice(cur, cur+chunkSize),
                    filename: filename,
                    index: idx
                }
                chunkList.push(chunk)
                cur += chunkSize
                idx++
            }
            return chunkList
        }
        /**
         * @params options
         *      methods {string}
         *      url {string}
         *      headers {object}
         *          k:v
         * */
        const request = (options) => {
            const {methods, url, headers, params} = options
            return new Promise((resolve,reject) => {
                const xhr = new XMLHttpRequest()
                xhr.open(methods, url, true)
                for (const key in headers) {
                    if (Object.hasOwnProperty.call(headers, key)) {
                        const element = headers[key];
                        xhr.setRequestHeader(key, element)
                    }
                }
                xhr.onreadystatechange = () => {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            resolve(xhr.responseText)
                        } else {
                            reject(new Error('error'))
                        }
                    } else {
                        reject(new Error('error'))
                    }
                }
                xhr.send(params)
            })
            

        }

    </script>
</body>
</html>